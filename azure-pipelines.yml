# =========================================
# Azure DevOps Pipeline - TempApp (no az login)
# =========================================

trigger:
  branches:
    include:
      - master

pool:
  name: "my new agent pool"

variables:
  imageName: "tempapp"
  acrName: "tempappacr"
  aksClusterName: "TempAppAKS"
  resourceGroup: "tailspin-space-game-rg"

stages:
- stage: Build
  displayName: Build and Push Docker Image
  jobs:
  - job: Build
    steps:
    - checkout: self

    # Debug: list files
    - script: |
        echo "Current path:"
        pwd
        echo "Files in working directory:"
        ls -R
      displayName: "Debug: show files"

    # Build and push using Docker task with ACR service connection
    - task: Docker@2
      displayName: Build and Push Docker Image
      inputs:
        command: buildAndPush
        containerRegistry: 'Container Registry Connection'
        repository: '$(acrName).azurecr.io/$(imageName)'
        dockerfile: 'TempApp/Dockerfile'
        buildContext: 'TempApp'
        tags: |
          $(Build.BuildId)

- stage: Deploy
  displayName: Deploy to AKS
  dependsOn: Build
  jobs:
  - job: Deploy
    steps:
    - checkout: self

    # Deploy to AKS using Kubernetes service connection
    - task: KubernetesManifest@1
      inputs:
        action: 'deploy'
        connectionType: 'azureResourceManager'
        azureSubscriptionConnection: 'Kubernetes Cluster Connection'
        azureResourceGroup: 'tailspin-space-game-rg'
        kubernetesCluster: 'TempAppAKS'
        namespace: 'default'
        manifests: |
          TempApp/k8s/deployment.yml
          TempApp/k8s/service.yml
        containers: 'tempapp=$(acrName).azurecr.io/tempapp:$(Build.BuildId)'

