# =========================================
# Azure DevOps Pipeline - TempApp (.NET 8 + AKS)
# =========================================

trigger:
  branches:
    include:
      - master

pool:
  name: "my new agent pool"

variables:
  imageName: "tempapp"
  acrName: "tempappacr"
  aksName: "TempAppAKS"
  resourceGroup: "tailspin-space-game-rg"
  tag: "$(Build.BuildId)"

stages:
# ======================
# 1. BUILD AND PUSH IMAGE
# ======================
- stage: Build
  displayName: Build and Push Docker Image
  jobs:
  - job: Build
    displayName: Build & Push to ACR
    steps:
    - checkout: self

    # Debug - show files
    - script: |
        echo "Current path: $(System.DefaultWorkingDirectory)"
        ls -R
      displayName: "Debug: List files"

    # Login to ACR (uses Docker task)
    - task: Docker@2
      displayName: Build and Push image to ACR
      inputs:
        containerRegistry: 'Container Registry Connection'
        repository: '$(imageName)'
        command: 'buildAndPush'
        Dockerfile: 'TempApp/Dockerfile'
        buildContext: 'TempApp'
        tags: |
          $(tag)

# ======================
# 2. DEPLOY TO AKS
# ======================
- stage: Deploy
  displayName: Deploy to AKS
  dependsOn: Build
  jobs:
  - deployment: DeployToAKS
    displayName: Deploy to AKS via KubernetesManifest
    environment: 'aks-tempapp'
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          - task: KubernetesManifest@1
            displayName: Deploy manifests to AKS
            inputs:
              action: 'deploy'
              connectionType: 'azureResourceManager'
              azureSubscriptionConnection: 'Kubernetes Cluster Connection'
              azureResourceGroup: '$(resourceGroup)'
              kubernetesCluster: '$(aksName)'
              namespace: 'default'
              manifests: |
                TempApp/k8s/deployment.yaml
                TempApp/k8s/service.yaml
              containers: |
                $(acrName).azurecr.io/$(imageName):$(tag)
