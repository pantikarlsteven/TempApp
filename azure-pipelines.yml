# ===============================
# Azure DevOps Pipeline - TempApp
# Build & Deploy to AKS
# ===============================

trigger:
  branches:
    include:
      - master

pool:
  name: "my new agent pool"

variables:
  imageName: "tempapp"
  acrName: "tempappacr"
  resourceGroup: "tailspin-space-game-rg"
  aksName: "TempAppAKS"

stages:
- stage: Build
  displayName: Build and Push Docker Image
  jobs:
  - job: Build
    steps:
    - checkout: self

    - script: |
        echo "Logging in to ACR..."
        az acr login --name $(acrName)

        echo "Building Docker image..."
        docker build -t $(acrName).azurecr.io/$(imageName):$(Build.BuildId) .

        echo "Pushing image..."
        docker push $(acrName).azurecr.io/$(imageName):$(Build.BuildId)
      displayName: Build and Push to ACR

- stage: Deploy
  displayName: Deploy to AKS
  dependsOn: Build
  jobs:
  - job: Deploy
    steps:
    - checkout: self

    - script: |
        echo "Getting AKS credentials..."
        az aks get-credentials --resource-group $(resourceGroup) --name $(aksName) --overwrite-existing

        echo "Updating image version..."
        kubectl set image deployment/tempapp-deployment tempapp=$(acrName).azurecr.io/$(imageName):$(Build.BuildId) || \
        kubectl apply -f k8s/

        echo "Deployment applied successfully!"
      displayName: Deploy to AKS
